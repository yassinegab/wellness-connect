{% extends 'base.html.twig' %}

{% block title %}Meal Analysis{% endblock %}

{% block body %}
<div class="flex min-h-screen bg-gray-50">
    <div class="flex flex-1 flex-col">
        {% include 'components/top-nav.html.twig' %}

        <main class="flex-1 overflow-auto p-4 lg:p-6">
            <div class="max-w-5xl mx-auto">
                
                <div class="mb-6">
                    <a href="{{ path('user_wellbeing_index') }}" class="text-gray-500 hover:text-gray-900 flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="md:flex h-full">
                        
                        <!-- Image Column -->
                        <div class="md:w-5/12 bg-gray-100 relative min-h-[400px]">
                            {% if meal.imageName %}
                                <img src="{{ asset('uploads/meals/' ~ meal.imageName) }}" alt="Meal" class="absolute inset-0 w-full h-full object-cover">
                            {% else %}
                                <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                                    <div class="text-center">
                                        <i class="fas fa-image text-5xl mb-3"></i>
                                        <p>No image available</p>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-6 text-white">
                                <p class="text-sm opacity-90 font-medium">Recorded on</p>
                                <p class="text-lg font-bold">{{ meal.createAt|date('F j, Y, g:i a') }}</p>
                            </div>
                        </div>

                        <!-- Content Column -->
                        <div class="md:w-7/12 p-8 flex flex-col">
                            
                            <div class="flex-1">
                                <div class="mb-8">
                                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Description</h3>
                                    <p class="text-xl text-gray-800 font-medium leading-relaxed">
                                        {{ meal.description|default('No description provided.') }}
                                    </p>
                                </div>

                                 <div>
                                    <h3 class="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                        <i class="fas fa-robot text-lg"></i> AI Nutrition Analysis
                                    </h3>

                                    {# Nutritional Stats Grid #}
                                    <div class="grid grid-cols-3 gap-4 mb-6">
                                        <div class="bg-blue-50/50 rounded-2xl p-4 border border-blue-100 text-center transition-transform hover:scale-105">
                                            <p class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1">Calories</p>
                                            <p class="text-2xl font-black text-blue-900">{{ meal.calories|default('0') }}</p>
                                            <p class="text-[10px] font-medium text-blue-500">kcal</p>
                                        </div>
                                        <div class="bg-rose-50/50 rounded-2xl p-4 border border-rose-100 text-center transition-transform hover:scale-105">
                                            <p class="text-[10px] font-bold text-rose-400 uppercase tracking-wider mb-1">Sugar</p>
                                            <p class="text-2xl font-black text-rose-900">{{ meal.sugar|default('0') }}</p>
                                            <p class="text-[10px] font-medium text-rose-500">grams</p>
                                        </div>
                                        <div class="bg-emerald-50/50 rounded-2xl p-4 border border-emerald-100 text-center transition-transform hover:scale-105">
                                            <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider mb-1">Protein</p>
                                            <p class="text-2xl font-black text-emerald-900">{{ meal.protein|default('0') }}</p>
                                            <p class="text-[10px] font-medium text-emerald-500">grams</p>
                                        </div>
                                    </div>
                                    
                                    {% if meal.aiAnalysis %}
                                        {% set fullText = meal.aiAnalysis|trim %}
                                        {% if '**Stress Insight:**' in fullText %}
                                            {% set parts = fullText|split('**Stress Insight:**') %}
                                            {% set mainText = parts[0]|trim %}
                                            {% set stressInsight = parts[1]|trim %}
                                        {% else %}
                                            {% set mainText = fullText %}
                                            {% set stressInsight = null %}
                                        {% endif %}

                                        <div class="bg-indigo-50/50 rounded-xl p-5 border border-indigo-100 text-gray-700 text-sm leading-relaxed">
                                            {{ mainText|nl2br }}
                                        </div>
                                        {% if stressInsight %}
                                            <div class="mt-3 flex items-start gap-2 bg-amber-50 border border-amber-200 rounded-xl p-4 text-sm text-amber-800">
                                                <i class="fas fa-link text-amber-500 mt-0.5 flex-shrink-0"></i>
                                                <span>{{ stressInsight }}</span>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="text-center py-6 text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i> Analysis pending or not available.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- User Actions -->
                            <div class="mt-8 pt-6 border-t border-gray-100 flex gap-4">
                                <a href="{{ path('user_meal_edit', {'id': meal.id}) }}" class="flex-1 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 py-2.5 px-4 rounded-lg font-medium text-center transition-colors shadow-sm">
                                    Edit Meal
                                </a>
                                
                                <form method="post" action="{{ path('user_meal_delete', {'id': meal.id}) }}" onsubmit="return confirm('Delete this meal?');" class="flex-1">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ meal.id) }}">
                                    <button class="w-full bg-red-50 text-red-600 hover:bg-red-100 py-2.5 px-4 rounded-lg font-medium transition-colors">
                                        Delete
                                    </button>
                                </form>
                            </div>

                        </div>

                    </div>
                </div>

            </div>
        </main>
    </div>
</div>
{% endblock %}
