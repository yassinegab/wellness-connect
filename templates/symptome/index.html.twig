{% extends 'base.html.twig' %}


{% block title %}Ajouter Symptomes{% endblock %}

{% block body %}
<div class="flex min-h-screen bg-background">
  {% include 'components/sidebar.html.twig' %}
  <div class="flex flex-1 flex-col">
    {% include 'components/top-nav.html.twig' %}
    <main class="flex-1 overflow-auto">
      <div class="mx-auto max-w-7xl space-y-6 p-4 lg:p-6">

        <!-- Header -->
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-center gap-2 rounded-md border px-3 py-2">ðŸ“… {{ "now"|date("l d F Y") }}</div>
        </div>
    
<h2 class="text-2xl font-bold text-pink-600 mb-4">Ajouter vos symptÃ´mes ðŸŒ¸</h2>

<div id="symptomes-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for symptome in symptomesDisponibles %}
   <div class="symptome-item chroma-card"
     data-symptome="{{ symptome.value }}">

    <div class="chroma-bg"></div>

    <div class="chroma-content">
        <div class="symptome-label font-medium">
            {{ symptome.label }}
        </div>

        <select class="intensite-select" disabled>
            <option value="">Choisir l'intensitÃ© ðŸ’–</option>
            {% for label, value in intensites %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>

        <input type="date" class="date-observation" disabled>
    </div>
</div>
    {% endfor %}
</div>

<div class="flex gap-4 mt-6">
    <button id="save-symptomes" class="px-6 py-2 bg-pink-500 text-white font-semibold rounded-2xl hover:bg-pink-600 transition">Enregistrer</button>
    <a href="{{ path('cycle_index') }}" class="btn-outline">
                    Annuler
                </a>
</div>
<div>
<a href="{{ path('symptome_list') }}"
   class="px-6 py-2 bg-pink-400 text-white font-semibold rounded-2xl hover:bg-pink-500 transition">
    ðŸ“‹ Voir mes symptÃ´mes
</a>
    
    </div>
<!-- AI Floating Button -->
<button id="ai-btn" class="ai-fab">ðŸ¤–</button>

<!-- AI Chat Window -->
<div id="ai-chat" class="ai-chat hidden">
  <div class="ai-header">
    <span>AI Assistant ðŸ’•</span>
    <button id="ai-close">âœ–</button>
  </div>

  <div id="ai-messages" class="ai-messages"></div>

  <div class="ai-input">
    <input id="ai-text" type="text" placeholder="Ask me anything..." />
    <button id="ai-send">âž¤</button>
  </div>
</div>

{% endblock %}

{% block javascripts %}
<script>


// AI Chat Logic
const aiBtn = document.getElementById('ai-btn');
const aiChat = document.getElementById('ai-chat');
const aiClose = document.getElementById('ai-close');
const aiSend = document.getElementById('ai-send');
const aiInput = document.getElementById('ai-text');
const aiMessages = document.getElementById('ai-messages');

// Toggle Chat Window
aiBtn.addEventListener('click', () => aiChat.classList.toggle('hidden'));
aiClose.addEventListener('click', () => aiChat.classList.add('hidden'));

// Function to append messages
function appendMessage(role, text) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `ai-msg ${role}`;
    msgDiv.innerHTML = `<span>${text}</span>`;
    aiMessages.appendChild(msgDiv);
    aiMessages.scrollTop = aiMessages.scrollHeight;
}

// Send Message Logic
async function sendMessage() {
    const message = aiInput.value.trim();
    if (!message) return;

    appendMessage('user', message);
    aiInput.value = '';

    // Show loading state
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'ai-msg ai';
    loadingMsg.innerHTML = '<span>En train de rÃ©flÃ©chir... ðŸŒ¸</span>';
    aiMessages.appendChild(loadingMsg);

    try {
        const response = await fetch('{{ path('ai_chat') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();
        aiMessages.removeChild(loadingMsg); // Remove loading

        if (data.reply) {
            appendMessage('ai', data.reply);
        } else {
            appendMessage('ai', "Oups, j'ai eu un petit problÃ¨me.");
        }
    } catch (error) {
        aiMessages.removeChild(loadingMsg);
        appendMessage('ai', "Erreur de connexion.");
    }
}

aiSend.addEventListener('click', sendMessage);
aiInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});







const symptomeItems = document.querySelectorAll('.symptome-item');

symptomeItems.forEach(item => {
    // Clique sur la card pour activer
    item.addEventListener('click', (e) => {
        // EmpÃªche la propagation si on clique sur le select ou date
        if(e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;

        const isActive = item.classList.toggle('selected');
        const intensiteSelect = item.querySelector('.intensite-select');
        const dateInput = item.querySelector('.date-observation');
        intensiteSelect.disabled = !isActive;
        dateInput.disabled = !isActive;

        if(isActive) {
            item.classList.add('bg-pink-300', 'shadow-md');
        } else {
            item.classList.remove('bg-pink-300', 'shadow-md');
        }
    });
});

// Bouton Enregistrer
document.getElementById('save-symptomes').addEventListener('click', async () => {
    const data = [];
    symptomeItems.forEach(item => {
        if(item.classList.contains('selected')) {
            data.push({
                type: item.dataset.symptome,
                intensite: item.querySelector('.intensite-select').value,
                dateObservation: item.querySelector('.date-observation').value
            });
        }
    });

    if(data.length === 0){
        alert("Veuillez sÃ©lectionner au moins un symptÃ´me.");
        return;
    }

    const response = await fetch('{{ path('symptome_create') }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });

    if (response.ok) {
        alert('SymptÃ´mes enregistrÃ©s ! ðŸŒ¸');
        location.reload();
    } else {
        alert('Erreur lors de l\'enregistrement.');
    }
});

// Bouton Annuler
document.getElementById('cancel-symptomes').addEventListener('click', () => {
    symptomeItems.forEach(item => {
        item.classList.remove('selected', 'bg-pink-300', 'shadow-md');
        item.querySelector('.intensite-select').disabled = true;
        item.querySelector('.date-observation').disabled = true;
        item.querySelector('.intensite-select').value = "";
        item.querySelector('.date-observation').value = "";
    });
});
</script>
{% endblock %}
{% block stylesheets %}
<style>
/* Floating button */
.ai-fab {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #ec4899;
  color: white;
  font-size: 24px;
  border: none;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,.15);
  z-index: 9999;
}

/* Chat window */
.ai-chat {
  position: fixed;
  bottom: 90px;
  right: 24px;
  width: 320px;
  height: 420px;
  background: #fff1f2;
  border-radius: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,.2);
  display: flex;
  flex-direction: column;
  z-index: 9999;
}

.hidden { display: none; }

.ai-header {
  background: #ec4899;
  color: white;
  padding: 10px 14px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
}

.ai-messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  font-size: 14px;
}

.ai-msg.user { text-align: right; margin-bottom: 8px; }
.ai-msg.ai { text-align: left; margin-bottom: 8px; }

.ai-msg span {
  display: inline-block;
  padding: 8px 10px;
  border-radius: 12px;
  max-width: 80%;
}

.ai-msg.user span { background: #ec4899; color: white; }
.ai-msg.ai span { background: #fbcfe8; color: #831843; }

.ai-input {
  display: flex;
  padding: 10px;
  gap: 6px;
}

.ai-input input {
  flex: 1;
  border-radius: 10px;
  border: 1px solid #f9a8d4;
  padding: 6px 10px;
}

.ai-input button {
  background: #ec4899;
  border: none;
  color: white;
  border-radius: 10px;
  padding: 0 12px;
}

/* === CHROMA CARD === */
.chroma-card {
    position: relative;
    border-radius: 1.5rem;
    padding: 1.2rem;
    background: #fff1f2;
    cursor: pointer;
    overflow: hidden;
    transition: transform .25s ease, box-shadow .25s ease;
    --mx: 50%;
    --my: 50%;
}

/* gradient vivant */
.chroma-bg {
    position: absolute;
    inset: -2px;
    background: radial-gradient(
        300px at var(--mx) var(--my),
        rgba(236,72,153,0.45),
        transparent 70%
    );
    opacity: 0;
    transition: opacity .3s ease;
}

/* contenu au dessus */
.chroma-content {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: .6rem;
}

/* hover */
.chroma-card:hover {
    transform: translateY(-6px) scale(1.04);
    box-shadow: 0 20px 45px rgba(236,72,153,.35);
}

.chroma-card:hover .chroma-bg {
    opacity: 1;
}

/* selected */
.chroma-card.selected {
    background: linear-gradient(135deg,#fce7f3,#fbcfe8);
    box-shadow: 0 25px 55px rgba(236,72,153,.45);
}

/* inputs */
.chroma-card select,
.chroma-card input {
    border-radius: 999px;
    border: 2px solid #fbcfe8;
    padding: .4rem .8rem;
    transition: all .25s ease;
}

.chroma-card select:focus,
.chroma-card input:focus {
    outline: none;
    border-color: #ec4899;
    box-shadow: 0 0 0 4px rgba(236,72,153,.25);
}
</style>
{% endblock %}
